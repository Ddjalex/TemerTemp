<% 
const pageTitle = isEdit ? 'Edit Property' : 'Add New Property';
%>

<%- include('../layout', { 
  title: pageTitle + ' - Temer Properties Admin', 
  pageTitle,
  body: `
    <div class="row">
      <div class="col-lg-8">
        <form method="POST" action="${isEdit ? '/admin/properties/' + property._id + '?_method=PUT' : '/admin/properties'}" enctype="multipart/form-data" class="needs-validation" novalidate>
          
          <!-- Basic Information -->
          <div class="card mb-4">
            <div class="card-header">
              <h5 class="mb-0"><i class="bi bi-info-circle"></i> Basic Information</h5>
            </div>
            <div class="card-body">
              <div class="row">
                <div class="col-md-12 mb-3">
                  <label for="title" class="form-label">Property Title *</label>
                  <input type="text" class="form-control" id="title" name="title" value="${property ? property.title : ''}" required>
                  <div class="invalid-feedback">Please provide a property title.</div>
                </div>
                
                <div class="col-md-12 mb-3">
                  <label for="description" class="form-label">Description *</label>
                  <textarea class="form-control" id="description" name="description" rows="4" required>${property ? property.description : ''}</textarea>
                  <div class="invalid-feedback">Please provide a description.</div>
                </div>
                
                <div class="col-md-6 mb-3">
                  <label for="price" class="form-label">Price ($) *</label>
                  <input type="number" class="form-control" id="price" name="price" value="${property ? property.price : ''}" required>
                  <div class="invalid-feedback">Please provide a price.</div>
                </div>
                
                <div class="col-md-6 mb-3">
                  <label for="propertyType" class="form-label">Property Type *</label>
                  <select class="form-select" id="propertyType" name="propertyType" required>
                    <option value="">Select Type</option>
                    <option value="house" ${property && property.propertyType === 'house' ? 'selected' : ''}>House</option>
                    <option value="apartment" ${property && property.propertyType === 'apartment' ? 'selected' : ''}>Apartment</option>
                    <option value="condo" ${property && property.propertyType === 'condo' ? 'selected' : ''}>Condo</option>
                    <option value="townhouse" ${property && property.propertyType === 'townhouse' ? 'selected' : ''}>Townhouse</option>
                    <option value="villa" ${property && property.propertyType === 'villa' ? 'selected' : ''}>Villa</option>
                    <option value="land" ${property && property.propertyType === 'land' ? 'selected' : ''}>Land</option>
                    <option value="commercial" ${property && property.propertyType === 'commercial' ? 'selected' : ''}>Commercial</option>
                  </select>
                  <div class="invalid-feedback">Please select a property type.</div>
                </div>
                
                <div class="col-md-6 mb-3">
                  <label for="status" class="form-label">Status *</label>
                  <select class="form-select" id="status" name="status" required>
                    <option value="for-sale" ${property && property.status === 'for-sale' ? 'selected' : ''}>For Sale</option>
                    <option value="for-rent" ${property && property.status === 'for-rent' ? 'selected' : ''}>For Rent</option>
                    <option value="sold" ${property && property.status === 'sold' ? 'selected' : ''}>Sold</option>
                    <option value="rented" ${property && property.status === 'rented' ? 'selected' : ''}>Rented</option>
                    <option value="pending" ${property && property.status === 'pending' ? 'selected' : ''}>Pending</option>
                  </select>
                </div>
                
                <div class="col-md-6 mb-3">
                  <label for="agent" class="form-label">Agent *</label>
                  <select class="form-select" id="agent" name="agent" required>
                    <option value="">Select Agent</option>
                    ${agents.map(agent => `
                      <option value="${agent._id}" ${property && property.agent && property.agent._id === agent._id ? 'selected' : ''}>
                        ${agent.firstName} ${agent.lastName}
                      </option>
                    `).join('')}
                  </select>
                  <div class="invalid-feedback">Please select an agent.</div>
                </div>
              </div>
            </div>
          </div>

          <!-- Address -->
          <div class="card mb-4">
            <div class="card-header">
              <h5 class="mb-0"><i class="bi bi-geo-alt"></i> Address</h5>
            </div>
            <div class="card-body">
              <div class="row">
                <div class="col-md-12 mb-3">
                  <label for="street" class="form-label">Street Address *</label>
                  <input type="text" class="form-control" id="street" name="street" value="${property ? property.address.street : ''}" required>
                </div>
                
                <div class="col-md-6 mb-3">
                  <label for="city" class="form-label">City *</label>
                  <input type="text" class="form-control" id="city" name="city" value="${property ? property.address.city : ''}" required>
                </div>
                
                <div class="col-md-3 mb-3">
                  <label for="state" class="form-label">State *</label>
                  <input type="text" class="form-control" id="state" name="state" value="${property ? property.address.state : ''}" required>
                </div>
                
                <div class="col-md-3 mb-3">
                  <label for="zipCode" class="form-label">ZIP Code *</label>
                  <input type="text" class="form-control" id="zipCode" name="zipCode" value="${property ? property.address.zipCode : ''}" required>
                </div>
                
                <div class="col-md-6 mb-3">
                  <label for="latitude" class="form-label">Latitude</label>
                  <input type="number" step="any" class="form-control" id="latitude" name="latitude" value="${property && property.coordinates ? property.coordinates.latitude : ''}">
                </div>
                
                <div class="col-md-6 mb-3">
                  <label for="longitude" class="form-label">Longitude</label>
                  <input type="number" step="any" class="form-control" id="longitude" name="longitude" value="${property && property.coordinates ? property.coordinates.longitude : ''}">
                </div>
              </div>
            </div>
          </div>

          <!-- Features -->
          <div class="card mb-4">
            <div class="card-header">
              <h5 class="mb-0"><i class="bi bi-house"></i> Property Features</h5>
            </div>
            <div class="card-body">
              <div class="row">
                <div class="col-md-4 mb-3">
                  <label for="bedrooms" class="form-label">Bedrooms *</label>
                  <input type="number" class="form-control" id="bedrooms" name="bedrooms" value="${property ? property.features.bedrooms : ''}" required>
                </div>
                
                <div class="col-md-4 mb-3">
                  <label for="bathrooms" class="form-label">Bathrooms *</label>
                  <input type="number" step="0.5" class="form-control" id="bathrooms" name="bathrooms" value="${property ? property.features.bathrooms : ''}" required>
                </div>
                
                <div class="col-md-4 mb-3">
                  <label for="sqft" class="form-label">Square Feet *</label>
                  <input type="number" class="form-control" id="sqft" name="sqft" value="${property ? property.features.sqft : ''}" required>
                </div>
                
                <div class="col-md-4 mb-3">
                  <label for="lotSize" class="form-label">Lot Size (sq ft)</label>
                  <input type="number" class="form-control" id="lotSize" name="lotSize" value="${property ? property.features.lotSize : ''}">
                </div>
                
                <div class="col-md-4 mb-3">
                  <label for="yearBuilt" class="form-label">Year Built</label>
                  <input type="number" class="form-control" id="yearBuilt" name="yearBuilt" value="${property ? property.features.yearBuilt : ''}">
                </div>
                
                <div class="col-md-4 mb-3">
                  <label for="garage" class="form-label">Garage Spaces</label>
                  <input type="number" class="form-control" id="garage" name="garage" value="${property ? property.features.garage : '0'}">
                </div>
                
                <div class="col-md-12 mb-3">
                  <label for="amenities" class="form-label">Amenities (comma-separated)</label>
                  <input type="text" class="form-control" id="amenities" name="amenities" value="${property ? property.amenities.join(', ') : ''}" placeholder="Pool, Gym, Parking, etc.">
                </div>
              </div>
            </div>
          </div>

          <!-- Images -->
          <div class="card mb-4">
            <div class="card-header">
              <h5 class="mb-0"><i class="bi bi-images"></i> Property Images</h5>
            </div>
            <div class="card-body">
              <div class="mb-3">
                <label for="images" class="form-label">Upload Images</label>
                <input type="file" class="form-control" id="images" name="images" multiple accept="image/*">
                <div class="form-text">Select multiple images. First image will be the primary image.</div>
              </div>
              
              ${property && property.images && property.images.length > 0 ? `
                <div class="mb-3">
                  <label class="form-label">Current Images</label>
                  <div class="row">
                    ${property.images.map((image, index) => `
                      <div class="col-md-3 mb-3">
                        <div class="position-relative">
                          <img src="${image.url}" class="img-fluid rounded" alt="${image.alt}">
                          ${image.isPrimary ? '<span class="badge bg-primary position-absolute top-0 start-0 m-1">Primary</span>' : ''}
                        </div>
                      </div>
                    `).join('')}
                  </div>
                </div>
              ` : ''}
            </div>
          </div>

          <!-- Settings -->
          <div class="card mb-4">
            <div class="card-header">
              <h5 class="mb-0"><i class="bi bi-toggles"></i> Settings</h5>
            </div>
            <div class="card-body">
              <div class="row">
                <div class="col-md-6">
                  <div class="form-check">
                    <input class="form-check-input" type="checkbox" id="isActive" name="isActive" ${property && property.isActive !== false ? 'checked' : ''}>
                    <label class="form-check-label" for="isActive">
                      Active (visible on website)
                    </label>
                  </div>
                </div>
                
                <div class="col-md-6">
                  <div class="form-check">
                    <input class="form-check-input" type="checkbox" id="isFeatured" name="isFeatured" ${property && property.isFeatured ? 'checked' : ''}>
                    <label class="form-check-label" for="isFeatured">
                      Featured Property
                    </label>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <!-- Submit Buttons -->
          <div class="d-flex justify-content-between">
            <a href="/admin/properties" class="btn btn-secondary">
              <i class="bi bi-arrow-left"></i> Back to Properties
            </a>
            <button type="submit" class="btn btn-primary">
              <i class="bi bi-check-lg"></i> ${isEdit ? 'Update Property' : 'Create Property'}
            </button>
          </div>
        </form>
      </div>
      
      <div class="col-lg-4">
        <div class="card">
          <div class="card-header">
            <h6 class="mb-0"><i class="bi bi-lightbulb"></i> Tips</h6>
          </div>
          <div class="card-body">
            <ul class="list-unstyled mb-0">
              <li class="mb-2"><i class="bi bi-check-circle text-success"></i> Use high-quality images for better engagement</li>
              <li class="mb-2"><i class="bi bi-check-circle text-success"></i> Write detailed descriptions to attract buyers</li>
              <li class="mb-2"><i class="bi bi-check-circle text-success"></i> Include all amenities and features</li>
              <li class="mb-2"><i class="bi bi-check-circle text-success"></i> Set accurate pricing based on market research</li>
              <li class="mb-0"><i class="bi bi-check-circle text-success"></i> Add location coordinates for map display</li>
            </ul>
          </div>
        </div>
      </div>
    </div>
  `,
  user
}) %>