<% 
const pageTitle = 'Properties';
%>

<%- include('../layout', { 
  title: 'Properties - Temer Properties Admin', 
  pageTitle,
  body: `
    <div class="d-flex justify-content-between align-items-center mb-4">
      <div>
        <h4 class="mb-0">Property Management</h4>
        <p class="text-muted mb-0">Manage your property listings</p>
      </div>
      <a href="/admin/properties/new" class="btn btn-primary">
        <i class="bi bi-plus-lg"></i> Add New Property
      </a>
    </div>

    <!-- Filters -->
    <div class="card mb-4">
      <div class="card-body">
        <form method="GET" class="row g-3">
          <div class="col-md-3">
            <input type="text" class="form-control" name="search" placeholder="Search properties..." value="${filters.search || ''}">
          </div>
          <div class="col-md-2">
            <select class="form-select" name="status">
              <option value="">All Status</option>
              <option value="for-sale" ${filters.status === 'for-sale' ? 'selected' : ''}>For Sale</option>
              <option value="for-rent" ${filters.status === 'for-rent' ? 'selected' : ''}>For Rent</option>
              <option value="sold" ${filters.status === 'sold' ? 'selected' : ''}>Sold</option>
              <option value="rented" ${filters.status === 'rented' ? 'selected' : ''}>Rented</option>
            </select>
          </div>
          <div class="col-md-2">
            <select class="form-select" name="type">
              <option value="">All Types</option>
              <option value="house" ${filters.type === 'house' ? 'selected' : ''}>House</option>
              <option value="apartment" ${filters.type === 'apartment' ? 'selected' : ''}>Apartment</option>
              <option value="condo" ${filters.type === 'condo' ? 'selected' : ''}>Condo</option>
              <option value="villa" ${filters.type === 'villa' ? 'selected' : ''}>Villa</option>
            </select>
          </div>
          <div class="col-md-3">
            <select class="form-select" name="agent">
              <option value="">All Agents</option>
              ${agents.map(agent => `
                <option value="${agent._id}" ${filters.agent === agent._id ? 'selected' : ''}>
                  ${agent.firstName} ${agent.lastName}
                </option>
              `).join('')}
            </select>
          </div>
          <div class="col-md-2">
            <button type="submit" class="btn btn-outline-primary w-100">Filter</button>
          </div>
        </form>
      </div>
    </div>

    <!-- Properties List -->
    <div class="card">
      <div class="card-body">
        ${properties.length > 0 ? `
          <div class="table-responsive">
            <table class="table table-hover">
              <thead>
                <tr>
                  <th>Property</th>
                  <th>Type</th>
                  <th>Price</th>
                  <th>Status</th>
                  <th>Agent</th>
                  <th>Created</th>
                  <th>Actions</th>
                </tr>
              </thead>
              <tbody>
                ${properties.map(property => `
                  <tr>
                    <td>
                      <div class="d-flex align-items-center">
                        ${property.images && property.images.length > 0 ? 
                          `<img src="${property.images[0].url}" alt="${property.title}" class="rounded me-3" style="width: 60px; height: 45px; object-fit: cover;">` : 
                          '<div class="bg-light rounded me-3 d-flex align-items-center justify-content-center" style="width: 60px; height: 45px;"><i class="bi bi-image text-muted"></i></div>'
                        }
                        <div>
                          <h6 class="mb-1">${property.title}</h6>
                          <small class="text-muted">${property.address.street}, ${property.address.city}</small>
                        </div>
                      </div>
                    </td>
                    <td><span class="badge bg-light text-dark">${property.propertyType}</span></td>
                    <td><strong>$${property.price.toLocaleString()}</strong></td>
                    <td><span class="badge bg-${property.status}">${property.status.replace('-', ' ')}</span></td>
                    <td>${property.agent ? property.agent.firstName + ' ' + property.agent.lastName : 'No agent'}</td>
                    <td>${new Date(property.createdAt).toLocaleDateString()}</td>
                    <td>
                      <div class="btn-group btn-group-sm">
                        <a href="/admin/properties/${property._id}" class="btn btn-outline-info" title="View">
                          <i class="bi bi-eye"></i>
                        </a>
                        <a href="/admin/properties/${property._id}/edit" class="btn btn-outline-primary" title="Edit">
                          <i class="bi bi-pencil"></i>
                        </a>
                        <button class="btn btn-outline-danger" data-confirm-delete data-url="/admin/properties/${property._id}" title="Delete">
                          <i class="bi bi-trash"></i>
                        </button>
                      </div>
                    </td>
                  </tr>
                `).join('')}
              </tbody>
            </table>
          </div>

          <!-- Pagination -->
          ${pagination.totalPages > 1 ? `
            <nav class="mt-4">
              <ul class="pagination justify-content-center">
                ${pagination.hasPrev ? `
                  <li class="page-item">
                    <a class="page-link" href="?page=${pagination.prevPage}&${new URLSearchParams(filters).toString()}">Previous</a>
                  </li>
                ` : ''}
                
                ${Array.from({length: pagination.totalPages}, (_, i) => i + 1).map(page => `
                  <li class="page-item ${page === pagination.currentPage ? 'active' : ''}">
                    <a class="page-link" href="?page=${page}&${new URLSearchParams(filters).toString()}">${page}</a>
                  </li>
                `).join('')}
                
                ${pagination.hasNext ? `
                  <li class="page-item">
                    <a class="page-link" href="?page=${pagination.nextPage}&${new URLSearchParams(filters).toString()}">Next</a>
                  </li>
                ` : ''}
              </ul>
            </nav>
          ` : ''}
        ` : `
          <div class="text-center py-5">
            <i class="bi bi-building fs-1 text-muted"></i>
            <h5 class="mt-3 text-muted">No properties found</h5>
            <p class="text-muted">Start by adding your first property listing.</p>
            <a href="/admin/properties/new" class="btn btn-primary">
              <i class="bi bi-plus-lg"></i> Add Property
            </a>
          </div>
        `}
      </div>
    </div>
  `,
  user
}) %>